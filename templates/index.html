<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sxmify</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body>
    <div class="container">
        <h1>Sxmify</h1>

        {% if error %}
        <div class="alert error">{{ error }}</div>
        {% endif %}

        <form action="{{ url_for('scrape') }}" method="POST" id="scrape-form">
            <input type="hidden" id="station_name" name="station_name" value="">
            <div class="form-group">
                <label for="station-search">Select Station</label>
                <div class="custom-select-wrapper">
                    <!-- Hidden input for form submission -->
                    <input type="hidden" id="url" name="url" required>

                    <!-- Visible Input for typing/searching -->
                    <input type="text" id="station-search" placeholder="Select or search for a station..."
                        autocomplete="off">

                    <!-- Dropdown List -->
                    <div id="station-options" class="station-options hidden">
                        {% for station in stations %}
                        <div class="station-option" data-value="{{ station.url }}"
                            data-sort="{{ '%05d'|format(station.number|int) }}" data-name="{{ station.name }}">
                            {{ station.name }}
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label for="scrape_type">Playlist Type</label>
                <select id="scrape_type" name="scrape_type">
                    <option value="recent">Recently Played</option>
                    <option value="newest">Newest Additions</option>
                    <option value="most_heard">Most Played</option>
                </select>
            </div>

            <div class="form-group" id="days_group" style="display: none;">
                <label for="days">Time Period</label>
                <select id="days" name="days">
                    <option value="7">Last 7 Days</option>
                    <option value="30">Last 30 Days</option>
                    <option value="60">Last 60 Days</option>
                </select>
            </div>

            <div class="form-group" id="limit_group">
                <label for="limit">Max Tracks</label>
                <input type="number" id="limit" name="limit" value="100" min="1" max="500">
            </div>
            <button type="submit" class="btn primary-btn" id="scrape-btn">Find Tracks</button>
        </form>
    </div>

    <script>
        // Custom Searchable Dropdown Logic
        document.addEventListener('DOMContentLoaded', function () {
            const searchInput = document.getElementById('station-search');
            const optionsContainer = document.getElementById('station-options');
            const hiddenInput = document.getElementById('url');
            const options = Array.from(document.querySelectorAll('.station-option'));

            // 1. Initial Sort
            options.sort((a, b) => {
                return a.dataset.sort.localeCompare(b.dataset.sort);
            });
            // Re-append in order
            options.forEach(opt => optionsContainer.appendChild(opt));

            // 2. Toggle Dropdown
            function showDropdown() {
                optionsContainer.classList.remove('hidden');
            }

            function hideDropdown() {
                // Small delay to allow click event to register
                setTimeout(() => {
                    optionsContainer.classList.add('hidden');
                }, 200);
            }

            searchInput.addEventListener('focus', showDropdown);
            searchInput.addEventListener('input', function () {
                showDropdown();
                const filter = this.value.toLowerCase();
                options.forEach(opt => {
                    const text = opt.innerText.toLowerCase();
                    if (text.includes(filter)) {
                        opt.style.display = 'block';
                    } else {
                        opt.style.display = 'none';
                    }
                });
            });

            // Hide when clicking outside
            document.addEventListener('click', function (e) {
                if (!searchInput.contains(e.target) && !optionsContainer.contains(e.target)) {
                    optionsContainer.classList.add('hidden');
                }
            });

            // 3. Selection
            options.forEach(opt => {
                opt.addEventListener('click', function () {
                    searchInput.value = this.dataset.name;
                    hiddenInput.value = this.dataset.value;
                    optionsContainer.classList.add('hidden');
                });
            });

            // Check if we already have a value (e.g. from session/browser cache)?
            // Not strictly needed since we start empty, but good validation.

            // Submit Button Logic
            const btn = document.getElementById('scrape-btn');
            if (btn) {
                btn.addEventListener('click', function () {
                    // Set station name before submit (though we use ID for that in backend usually)
                    const nameInput = document.getElementById('station_name');
                    if (nameInput && searchInput.value) {
                        nameInput.value = searchInput.value;
                    }

                    // Simple validation
                    if (!hiddenInput.value) {
                        alert("Please select a station from the list.");
                        return;
                    }

                    this.innerHTML = 'Finding Tracks... (this may take a few seconds)';
                    this.classList.add('disabled');
                });
            }
        });

        const scrapeType = document.getElementById('scrape_type');
        const daysGroup = document.getElementById('days_group');
        const limitGroup = document.getElementById('limit_group');

        if (scrapeType && daysGroup && limitGroup) {
            scrapeType.addEventListener('change', function () {
                // Reset display
                daysGroup.style.display = 'none';
                limitGroup.style.display = 'none';

                if (this.value === 'most_heard') {
                    daysGroup.style.display = 'block';
                } else if (this.value === 'recent') {
                    limitGroup.style.display = 'block';
                }
            });
        }
    </script>
</body>

</html>